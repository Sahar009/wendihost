version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing dependencies..."
        - npm install
        - echo "Writing .env.production from Amplify environment variables..."
        - printf "DATABASE_URL=%s\n" "$DATABASE_URL" > .env.production
        - printf "SESSION_PASSWORD=%s\n" "$SESSION_PASSWORD" >> .env.production
        - printf "IRON_SESSION_SECRET=%s\n" "$IRON_SESSION_SECRET" >> .env.production
        - printf "NEXT_PUBLIC_APP_URL=%s\n" "$NEXT_PUBLIC_APP_URL" >> .env.production
        - printf "NEXT_PUBLIC_FIREBASE_API_KEY=%s\n" "$NEXT_PUBLIC_FIREBASE_API_KEY" >> .env.production
        - printf "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=%s\n" "$NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN" >> .env.production
        - printf "NEXT_PUBLIC_FIREBASE_PROJECT_ID=%s\n" "$NEXT_PUBLIC_FIREBASE_PROJECT_ID" >> .env.production
        - printf "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=%s\n" "$NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET" >> .env.production
        - printf "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=%s\n" "$NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID" >> .env.production
        - printf "NEXT_PUBLIC_FIREBASE_APP_ID=%s\n" "$NEXT_PUBLIC_FIREBASE_APP_ID" >> .env.production
        - printf "NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=%s\n" "$NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME" >> .env.production
        - printf "NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET=%s\n" "$NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET" >> .env.production
        - echo "Generating Prisma Client..."
        - npx prisma generate
    build:
      commands:
        - echo "Building Next.js application..."
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - .prisma/**/*

